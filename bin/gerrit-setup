#!/usr/bin/env python

import argparse
from gerrit_python_tools import config, gerrit

DEFAULT_CONFIG = {
    'gerrit': {
        'host': 'localhost',
        'port': 29418,
        'username': 'SomeUser',
        'key_filename': None,
        'timeout': 10,
        'was-here-indicator': '### Setup by gerrit-setup ###'
    }
}


def get_args():
    parser = argparse.ArgumentParser(
        description='Setup initial gerrit users, groups, and projects'
    )
    parser.add_argument('yaml_file', type=str, help="Path to yaml file")
    args = parser.parse_args()
    return args

if __name__ == '__main__':
    args = get_args()
    _config = config.load_config(args.yaml_file, default=DEFAULT_CONFIG)

    ssh = gerrit.SSH(
        _config['gerrit']['host'],
        _config['gerrit']['port'],
        _config['gerrit']['timeout'],
        _config['gerrit']['username'],
        _config['gerrit']['key_filename']
    )

    groups = _config.get('groups', [])
    for group_data in groups:
        group = gerrit.Group(group_data)
        group.present(ssh)

    users = _config.get('users', [])
    for user_data in users:
        user = gerrit.User(user_data)
        user.present(ssh)

    # Get list of groups for building groups file
    groups = gerrit.get_groups(ssh)

    projects = _config.get('projects', [])
    for p in projects:
        project = gerrit.Project(p)
        project.ensure(ssh, _config['gerrit'], groups)
